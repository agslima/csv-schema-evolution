version: '3.9'

services:
  # --- BACKEND SERVICE ---
  backend:
    build: ./backend
    container_name: csv_engine_backend
    restart: always
    # We remove 'ports' here if we want to force access ONLY via Nginx (Security Best Practice)
    # But for debugging, we can keep it or comment it out.
    # ports:
    #   - "8000:8000" 
    expose:
      - "8000" # Only accessible to other containers
    environment:
      - MONGO_URI=mongodb://mongo:27017
      - DB_NAME=csv_engine_db
    depends_on:
      - mongo

  # --- FRONTEND SERVICE (NGINX) ---
  frontend:
    build: ./frontend
    container_name: csv_engine_frontend
    restart: always
    ports:
      - "80:80" # The entry point for the user
    depends_on:
      - backend

  # --- DATABASE ---
  mongo:
    image: mongo:6.0
    container_name: csv_engine_mongo
    restart: always
    expose:
      - "27017"
    volumes:
      - mongo_data:/data/db

volumes:
  mongo_data:

###

services:
  mongo:
    image: mongo:6
    container_name: csv-mongo
    restart: unless-stopped
    # Security: Do NOT expose ports to the host/public unless testing locally
    # If needed for local tools, bind to localhost only:
    # ports:
    #   - "127.0.0.1:27017:27017"
    
    environment:
      # Security: Enable Authentication
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: csv_uploader
    
    volumes:
      - mongo_data:/data/db
    
    # Security: Isolate DB in a backend network
    networks:
      - secure-net
    
    # Security: Resource limits to prevent DoS crashing the host
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: agslima/csv-ingestion-engine:latest
    container_name: csv-backend
    restart: unless-stopped
    
    # Security: Drop capabilities (Rootless is handled in Dockerfile, but this is extra insurance)
    cap_drop:
      - ALL
    
    # Security: Run with Read-Only filesystem (optional, but recommended for high security)
    # We mount /tmp as a tmpfs because Python needs to write temporary files
    read_only: true
    tmpfs:
      - /tmp
    
    ports:
      - "8000:8000"
    
    env_file:
      - .env
    
    # removed the 'command' override. 
    # Why? We want to use the CMD defined in the secure Dockerfile ("app.main:app").
    # Overriding it with "--reload" is strictly for development and dangerous in prod.
    
    depends_on:
      - mongo
    
    networks:
      - secure-net

# Define a private network
networks:
  secure-net:
    driver: bridge

volumes:
  mongo_data:
