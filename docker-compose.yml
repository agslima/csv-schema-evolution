version: '3.9'

services:
  # --- 1. DATABASE (Secure) ---
  mongo:
    image: mongo:6.0
    container_name: csv_engine_mongo
    restart: unless-stopped
    # Security: Only expose port to internal network, NOT to the host
    expose:
      - "27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: csv_engine_db
    volumes:
      - mongo_data:/data/db
    networks:
      - secure-net
    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # --- 2. BACKEND API (Hardened) ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: csv_engine_backend
    restart: unless-stopped
    
    # Security: Drop root capabilities
    cap_drop:
      - ALL
    
    # Security: Read-only filesystem (Write only to /tmp)
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid
    
    # Networking: Only accessible by Frontend, not the public internet
    expose:
      - "8000"
    
    # Load secrets
    env_file:
      - ./backend/.env
    
    # Construct Connection String using variables from .env
    environment:
      - MONGO_URI=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongo:27017/?authSource=admin
      - DB_NAME=csv_engine_db
      
    depends_on:
      - mongo
    networks:
      - secure-net

  # --- 3. FRONTEND (Nginx Proxy) ---
  frontend:
    build: 
      context: ./frontend
    container_name: csv_engine_frontend
    restart: unless-stopped
    # The ONLY public port
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - secure-net

# --- NETWORKS & VOLUMES ---
networks:
  secure-net:
    driver: bridge

volumes:
  mongo_data: