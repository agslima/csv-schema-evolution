name: "Build & Delivery"

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Existing tag (e.g., v1.2.3)'
        required: true
        type: string
        
concurrency:
  group: delivery-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ------------------------------------------------------------------
  # JOB 1: Build & Publish Containers (Trusted Builder)
  # ------------------------------------------------------------------
  build-push:
    name: Build & Push
    runs-on: ubuntu-latest

    environment:
      name: production   # ðŸ”’ Environment Protection Rules
      
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: backend
            context: ./backend
            image_repo: csv-engine-backend
          - name: frontend
            context: ./frontend
            image_repo: csv-engine-frontend

    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: Login to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # --------------------------------------------------------------
      # Unified Build Step (Simplifies logic)
      # --------------------------------------------------------------
      - name: Build & Push (${{ matrix.name }})
        id: build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: ${{ matrix.context }}
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}:${{ github.sha }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}:latest
            ${{ startsWith(github.ref, 'refs/tags/v') && format('{0}/{1}:{2}', secrets.DOCKER_HUB_USERNAME, matrix.image_repo, github.ref_name) || '' }}

      # --------------------------------------------------------------
      # Export Digest via Artifact (The Fix)
      # --------------------------------------------------------------
      - name: Export Digest
        run: |
          mkdir -p digests
          echo "${{ steps.build.outputs.digest }}" > digests/digest-${{ matrix.name }}
      
      - name: Upload Digest Artifact
        uses: actions/upload-artifact@v7
        with:
          name: digest-${{ matrix.name }}
          path: digests/digest-${{ matrix.name }}
          retention-days: 1

      # --------------------------------------------------------------
      # Vulnerability Scan
      # --------------------------------------------------------------
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@e368e328979b113139d6f9068e03accaed98a518 # v0.34.1
        with:
          image-ref: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}:${{ github.sha }}
          severity: "CRITICAL,HIGH"
          exit-code: "1"

  # ------------------------------------------------------------------
  # JOB 2: Sign, Attest & Provenance (Release Only)
  # ------------------------------------------------------------------
  sign-and-attest:
    name: Sign & Attest (SLSA)
    # if: startsWith(github.ref, 'refs/tags/v')
    # if: github.repository == 'agslima/csv-schema-evolution'
    needs: build-push
    runs-on: ubuntu-latest

    environment:
      name: production   # ðŸ”’ Same protected environment

    permissions:
      # contents: read
      packages: write
      id-token: write          # OIDC for Cosign
      attestations: write      # GitHub provenance upload

    strategy:
      matrix:
        include:
          - name: backend
            image_repo: csv-engine-backend
          - name: frontend
            image_repo: csv-engine-frontend

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Login to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # --------------------------------------------------------------
      # Retrieve Digest
      # --------------------------------------------------------------
      - name: Download Digest Artifact
        uses: actions/download-artifact@v8
        with:
          name: digest-${{ matrix.name }}
          path: digests

      - name: Read Digest
        id: digest
        run: |
          DIGEST=$(cat digests/digest-${{ matrix.name }})
          echo "DIGEST=$DIGEST" >> $GITHUB_ENV
          echo "IMAGE=${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}@$DIGEST" >> $GITHUB_ENV

      # --------------------------------------------------------------
      # Keyless signing (digest-pinned)
      # --------------------------------------------------------------
      - name: Sign Image (Digest)
        run: |
          cosign sign --yes "$IMAGE"

      - name: Verify Signature
        run: |
          cosign verify "$IMAGE" \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            --certificate-identity-regexp "https://github.com/${{ github.repository }}/.*"

      # --------------------------------------------------------------
      # SBOM generation & attestation
      # --------------------------------------------------------------
      - name: Generate SBOM
        uses: anchore/sbom-action@17ae1740179002c89186b61233e0f892c3118b11 #v0.23.0
        with:
          image: ${{env.IMAGE}}
          format: spdx-json
          # FIX: Explicitly save the file to the current directory
          output-file: sbom-${{ matrix.image_repo }}.spdx.json
          # This controls the name of the artifact uploaded to GitHub UI
          artifact-name: sbom-${{ matrix.image_repo }}.spdx.json

      - name: Attest SBOM
        run: |
          cosign attest --yes \
            --type spdx \
            --predicate sbom-${{ matrix.image_repo }}.spdx.json \
            "$IMAGE"

      # --------------------------------------------------------------
      # SLSA Provenance (Digest-Correct)
      # --------------------------------------------------------------
      - name: Attest Build Provenance (SLSA)
        uses: actions/attest-build-provenance@a2bbfa25375fe432b6a289bc6b6cd05ecd0c4c32 # v4.1.0
        with:
          subject-name: index.docker.io/${{ secrets.DOCKER_HUB_USERNAME }}/${{ matrix.image_repo }}
          subject-digest: ${{ env.DIGEST }} # Uses the ENV var loaded from artifact
          push-to-registry: true
