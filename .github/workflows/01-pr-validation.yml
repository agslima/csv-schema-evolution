name: "CI Pipeline"

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

# Concurrency Control
# Cancels previous runs of the same PR to save resources
concurrency:
  group: ci-${{ github.ref }} # ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------------
  # JOB 1: Code Security & Quality (Python)
  # ------------------------------------------------------------------
  code-quality:
    name: Code Quality & Security
    if: github.repository == 'agslima/csv-schema-evolution'
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Safety Timeout
    permissions:
      contents: read
    
    services:
      mongo:
        image: mongo:6
        # ports: ["27017:27017"]
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok'"
          --health-cmd "mongosh --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval=10s
          --health-retries=5

    env:
      MONGODB_URI: mongodb://mongo:27017
      PYTHON_VERSION: "3.11"

    steps:
      # SHA Pinning for Supply Chain Security
      - name: Checkout Code
        uses: actions/checkout@v6 # checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 0

      # Pinned: gitleaks/gitleaks-action@v2.3.8
      - name: Secret Scanning (Gitleaks)
        if: vars.ENABLE_GITLEAKS == 'true'
        uses: gitleaks/gitleaks-action@v2  # gitleaks-action@f65c4cd93c2004495537552554e7c75d5069b2d8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 #v5.4.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install Dependencies
        run: |
          pip install --require-hashes -r backend/requirements.txt
          pip install bandit pylint pytest pytest-cov

      - name: SAST - Logic Analysis (Bandit)
        run: bandit -r backend -ll -ii

      - name: SCA - Dependency Analysis (Snyk)
        if: vars.ENABLE_SNYK_SCANS == 'true'
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        # Use npx to run snyk without global install overhead
        run: npx snyk@1.1290.0 test --file=backend/requirements.txt --package-manager=pip --severity-threshold=high

      - name: Code Linting (Pylint)
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/backend
          pylint backend \
            --fail-under=8.5 \
            --output-format=colorized

      - name: Unit & Integration Tests
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/backend
          pytest backend/tests \
            --cov=backend/app \
            --cov-report=xml \
            --cov-config=.coveragerc \
            --cov-fail-under=85

      - name: Upload Coverage
        uses: codecov/codecov-action@v5 # 1e68e06f1dbfde0f4cefc87efeba9e4643565303 # v5.3.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml

  # ------------------------------------------------------------------
  # JOB 2: Infrastructure Linting (Docker)
  # ------------------------------------------------------------------
  docker-lint:
    name: Docker Linting
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1

      # Hadolint (Shift Left)
      - name: Lint Backend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0 # v3.1.0
        with:
          dockerfile: backend/Dockerfile

      - name: Lint Frontend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        # uses: hadolint/hadolint-action@5429efd3704d5ed3cd4d18cd62097269a8317726 # v3.1.0
        with:
          dockerfile: frontend/Dockerfile

  # ------------------------------------------------------------
  # Docker Build (No Push)
  # ------------------------------------------------------------
  docker-build:
    name: Docker Build (No Push)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Build Backend Image
        run: docker build ./backend

      - name: Build Frontend Image
        run: docker build ./frontend
